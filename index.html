<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="underscore.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <title>
  Twittler
  </title>
  
  <body>
    
    <script>
      $(document).ready(function(){
        var $body = $('body');
        var previousStreamLength;
        $body.html('<h1> Your stream on Twittler... </h1><form action="">First name:<br><input type="text" name="firstname" value="John"><br></form><input type="submit" value="Submit">');
        setInterval(function(){
          $('.post').remove();
          $('.pre').remove();
          $('.user').remove();
          // $body.empty();
          var index = streams.home.length - 1;
          var cutoff=index-10;
          // console.log(streams.home[index].created_at.getTime());
          var triggered2=false;
          while (index>=cutoff && index > 0){
            if ($('.head')[0]!= undefined){
              var s="";
              var z=$('.head')[0].textContent.slice(1);
              if (triggered2===false){
                console.log(z);
                
                $('.tweets').remove();
                $('.head').remove();
                // $('br').remove();
                // var s="";
                // console.log( onlyUserName);
                _.each(streams.users[z],function(item){
                    s="<div class='tweets'>"+item.message+"</div>"+s;
                });
                  s="<div class='combined'><div class='head'>@"+z+"</div>"+s;
                  s+="</div>"
                  // console.log(s);
                  $(s).appendTo($body);
                  triggered2=true;
                }              
            }
            
            // var $usersTweets=$('<div class="tweets"></div>');

            var triggered=false;
            $( "div.user" ).click(function() {

              var onlyUserName=$(this)['context'].textContent.slice(1);
              // run this only once, not 9 times.
              if (triggered===false){
                // build only head class. the other function takes care of populating tweets
                s="<div class='head'>@"+onlyUserName+"</div>";
                $('.head').remove();
                $(s).appendTo($body);
                triggered=true;
              } 
            }); 
            var tweet = streams.home[index];
            var $tweet = $('<div id="post" class="post"></div>');
            var $tweetTime = $('<div id="pre" class="pre"></div>');
            var $tweetUser = $('<div id="'+tweet.user+'" class="user"></div>');
            // $tweet[name]=index;
            // console.log(new Date().getTime());
            // console.log($tweet);
            var writeup=function(){
              var elapsed=(new Date().getTime()-tweet.created_at.getTime())/1000;
            if (elapsed<10){
              return "Just now..."
            }
            else{
              if (elapsed<40){
                return "A few seconds ago";
              }
              if (elapsed<70){
                return "A minute ago";
              }
              if (elapsed<120){
                return "A couple minutes ago";
              }
              else{
                return "A few minutes ago";
              }

            }
          };
                             
            $tweetTime.text(writeup());
            $tweet.text(tweet.message);
            $tweetUser.text('@'+tweet.user);
            
            // $( "div" ).remove( ":contains('"+index+"')" );
            // $('<div class="main">').appendTo($body);
            $tweetUser.appendTo($body);
            $tweet.appendTo($body);
            $tweetTime.appendTo($body);
            // $('</div>').appendTo($body);
            // $("body").prepend($tweet);
            index -= 1;
          }

        },2000);

      });

    </script>
  </body>
</html>
